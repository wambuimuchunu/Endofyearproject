<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter - Enhanced</title>
    <link rel="stylesheet" href="converter.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Currency Converter</h1>
        <div class="user-menu">
            <a href="login.html" class="login-link" id="login-link">Login/Signup</a>
            <a href="profile.html" class="profile-link" id="profile-link" style="display: none;">
                Profile
            </a>
        </div>
        <nav>
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
            <a href="converter.html">Converter</a>
            <a href="profile.html" id="profile-nav" style="display: none;">Profile</a>
        </nav>
    </header>
    
    <div class="container">
        <section class="hero">
            <h2>Easy Currency Conversion</h2>
            <p>Enter the amount and select currencies to get accurate conversions powered by real-time exchange rates.</p>
        </section>

        <div class="converter-layout">
            <!-- Main Converter -->
            <div class="converter-main">
                <h3>Currency Converter</h3>
                
                <!-- Popular Pairs Section -->
                <div id="popular-pairs" class="popular-pairs">
                    <!-- Popular pairs will be loaded here -->
                </div>
                
                <form id="converter-form">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" placeholder="Enter amount" step="0.01" required>
                    
                    <label for="from-currency">From Currency:</label>
                    <select id="from-currency" required>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="INR">INR - Indian Rupee</option>
                        <option value="KES">KES - Kenyan Shilling</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                        <option value="CHF">CHF - Swiss Franc</option>
                        <option value="CNY">CNY - Chinese Yuan</option>
                    </select>
                    
                    <label for="to-currency">To Currency:</label>
                    <select id="to-currency" required>
                        <option value="EUR">EUR - Euro</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="INR">INR - Indian Rupee</option>
                        <option value="KES">KES - Kenyan Shilling</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                        <option value="CHF">CHF - Swiss Franc</option>
                        <option value="CNY">CNY - Chinese Yuan</option>
                    </select>
                    
                    <button type="submit" class="convert-btn">Convert</button>
                </form>
                
                <div id="result" class="result" style="display: none;"></div>
            </div>
            
            <!-- Conversion History Sidebar -->
            <div class="history-sidebar">
                <h3>Conversion History</h3>
                <div id="history-content">
                    <p style="text-align: center; color: #666;">Login to view history</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 Currency Converter. All rights reserved.</p>
    </footer>
    
    <script src="script.js"></script>
    <script>
        let isAuthenticated = false;

        // Check authentication on page load
        async function checkAuthentication() {
            try {
                const response = await fetch('check_auth.php');
                const data = await response.json();
                
                isAuthenticated = data.authenticated;
                
                if (isAuthenticated) {
                    // Update header
                    document.getElementById('login-link').style.display = 'none';
                    document.getElementById('profile-link').style.display = 'block';
                    document.getElementById('profile-link').textContent = `Welcome, ${data.username}`;
                    document.getElementById('profile-nav').style.display = 'inline';
                    
                    // Load user-specific data
                    loadPopularPairs();
                    loadConversionHistory();
                } else {
                    document.getElementById('login-link').style.display = 'block';
                    document.getElementById('profile-link').style.display = 'none';
                    document.getElementById('profile-nav').style.display = 'none';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                isAuthenticated = false;
            }
        }

        // Load popular pairs
        async function loadPopularPairs() {
            if (!isAuthenticated) return;
            
            try {
                const response = await fetch('get_popular_pairs.php');
                const data = await response.json();
                
                if (data.success && data.pairs && data.pairs.length > 0) {
                    const container = document.getElementById('popular-pairs');
                    container.innerHTML = '<p style="margin-bottom: 10px;">Popular Pairs:</p>';
                    
                    data.pairs.forEach(pair => {
                        const button = document.createElement('button');
                        button.className = 'pair-btn';
                        button.textContent = `${pair.from_currency} → ${pair.to_currency}`;
                        button.type = 'button';
                        button.onclick = () => {
                            document.getElementById('from-currency').value = pair.from_currency;
                            document.getElementById('to-currency').value = pair.to_currency;
                        };
                        container.appendChild(button);
                    });
                }
            } catch (error) {
                console.error('Error loading popular pairs:', error);
            }
        }

        // Load conversion history
        async function loadConversionHistory() {
            if (!isAuthenticated) {
                document.getElementById('history-content').innerHTML = 
                    '<p style="text-align: center; color: #666;">Login to view history</p>';
                return;
            }
            
            try {
                const response = await fetch('get_history.php?limit=10');
                const data = await response.json();
                
                const historyContainer = document.getElementById('history-content');
                
                if (data.success && data.history && data.history.length > 0) {
                    historyContainer.innerHTML = '';
                    
                    data.history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.innerHTML = `
                            <div style="margin-bottom: 5px;">
                                <strong>${parseFloat(item.amount).toFixed(2)} ${item.from_currency}</strong> 
                                → 
                                <strong>${parseFloat(item.converted_amount).toFixed(2)} ${item.to_currency}</strong>
                            </div>
                            <div style="font-size: 0.85em; color: #888;">
                                Rate: ${parseFloat(item.exchange_rate).toFixed(4)} | 
                                ${new Date(item.conversion_date).toLocaleString()}
                            </div>
                        `;
                        div.style.padding = '10px';
                        div.style.marginBottom = '10px';
                        div.style.background = '#f8f9fa';
                        div.style.borderRadius = '8px';
                        div.style.borderLeft = '3px solid #667eea';
                        historyContainer.appendChild(div);
                    });
                } else {
                    historyContainer.innerHTML = 
                        '<p style="text-align: center; color: #666;">No conversion history yet. Start converting!</p>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('history-content').innerHTML = 
                    '<p style="text-align: center; color: #dc3545;">Error loading history</p>';
            }
        }

        // Handle form submission
        document.getElementById('converter-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const fromCurrency = document.getElementById('from-currency').value;
            const toCurrency = document.getElementById('to-currency').value;
            const resultDiv = document.getElementById('result');
            
            if (isNaN(amount) || amount <= 0) {
                resultDiv.textContent = 'Please enter a valid amount';
                resultDiv.style.display = 'block';
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                return;
            }
            
            if (fromCurrency === toCurrency) {
                resultDiv.textContent = 'Please select different currencies';
                resultDiv.style.display = 'block';
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                return;
            }
            
            // Show loading
            resultDiv.textContent = 'Converting...';
            resultDiv.style.display = 'block';
            resultDiv.style.backgroundColor = '#d1ecf1';
            resultDiv.style.color = '#0c5460';
            
            try {
                // Fetch exchange rate
                const response = await fetch(`https://api.frankfurter.app/latest?from=${fromCurrency}&to=${toCurrency}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch exchange rate');
                }
                
                const data = await response.json();
                
                if (!data.rates || !data.rates[toCurrency]) {
                    throw new Error('Exchange rate not available');
                }
                
                const rate = data.rates[toCurrency];
                const convertedAmount = (amount * rate).toFixed(2);
                
                // Display result
                resultDiv.textContent = `${amount} ${fromCurrency} = ${convertedAmount} ${toCurrency}`;
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.color = '#155724';
                
                // Save to database if logged in
                if (isAuthenticated) {
                    saveConversion(fromCurrency, toCurrency, amount, convertedAmount, rate);
                }
                
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                console.error('Conversion error:', error);
            }
        });

        // Save conversion to database
        async function saveConversion(fromCurrency, toCurrency, amount, convertedAmount, rate) {
            try {
                const formData = new FormData();
                formData.append('from_currency', fromCurrency);
                formData.append('to_currency', toCurrency);
                formData.append('amount', amount);
                formData.append('converted_amount', convertedAmount);
                formData.append('exchange_rate', rate);
                
                const response = await fetch('save_conversion.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload history and popular pairs
                    loadConversionHistory();
                    loadPopularPairs();
                }
            } catch (error) {
                console.error('Error saving conversion:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', checkAuthentication);
    </script>
</body>
</html>